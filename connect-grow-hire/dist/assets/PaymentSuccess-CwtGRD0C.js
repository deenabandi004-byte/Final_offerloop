import{u as S,at as j,r as m,j as e,z as N,av as U,aw as k}from"./vendor-react-CGb3T5FJ.js";import{a as v,B as x}from"./index-CkUgwTeu.js";import{g as P}from"./vendor-firebase-SSBCpsDT.js";function I(){const l=S(),[h]=j(),{user:c,refreshUser:y}=v(),[p,t]=m.useState("processing"),[g,o]=m.useState("Completing your upgrade..."),u=m.useRef(!1),i=h.get("session_id")||h.get("sessionId")||h.get("session")||(window.location.hash.includes("session_id=")?new URLSearchParams(window.location.hash.split("?")[1]||"").get("session_id"):null)||(window.location.search.includes("session_id=")?new URLSearchParams(window.location.search).get("session_id"):null);return m.useEffect(()=>{async function b(){if(u.current){console.log("PaymentSuccess: Already processed, skipping...");return}if(console.log("PaymentSuccess: Starting upgrade process",{user:!!c,sessionId:i,url:window.location.href,search:window.location.search,hash:window.location.hash}),!c){console.error("PaymentSuccess: No user found"),t("error"),o("You must be logged in to complete the upgrade. Please sign in and try again.");return}if(c.tier==="pro"){console.log("PaymentSuccess: User is already Pro, skipping upgrade call"),t("success"),o("You are already upgraded to Pro! ðŸŽ‰"),setTimeout(()=>{l("/home")},2e3),u.current=!0;return}if(u.current=!0,!i){console.warn("PaymentSuccess: No session ID in URL, checking if user is already upgraded...");try{const a=P().currentUser;if(!a)throw new Error("Not authenticated");const f=await a.getIdToken(),d=window.location.hostname==="localhost"?"http://localhost:5001":"https://www.offerloop.ai",n=await fetch(`${d}/api/subscription-status`,{method:"GET",headers:{Authorization:`Bearer ${f}`}});if(n.ok){const s=await n.json();if(console.log("PaymentSuccess: Subscription status:",s),s.subscribed&&s.tier==="pro"){console.log("PaymentSuccess: User is already upgraded to Pro"),await y(),t("success"),o("You are already upgraded to Pro! ðŸŽ‰"),setTimeout(()=>{l("/home")},2e3);return}}console.error("PaymentSuccess: No session ID and user not upgraded"),t("error"),o("Missing session information. If you just completed payment, the upgrade may be processing. Please wait a moment and refresh, or contact support with your payment confirmation.");return}catch(r){console.error("PaymentSuccess: Error checking user status:",r),t("error"),o("Missing session information. Please contact support with your payment confirmation.");return}}try{t("processing"),o("Completing your upgrade...");const a=P().currentUser;if(!a)throw new Error("Not authenticated");const f=await a.getIdToken(),d=window.location.hostname==="localhost"?"http://localhost:5001":"https://www.offerloop.ai";console.log("PaymentSuccess: Calling complete-upgrade endpoint...",{API_URL:d,sessionId:i});const n=await fetch(`${d}/api/complete-upgrade`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${f}`},body:JSON.stringify({sessionId:i})});console.log("PaymentSuccess: Response status:",n.status);const s=await n.json();if(console.log("PaymentSuccess: Response data:",s),n.ok&&s.success){console.log("PaymentSuccess: Upgrade successful:",s),t("success"),o("Successfully upgraded to Pro! ðŸŽ‰");try{await y(),console.log("PaymentSuccess: User data refreshed")}catch(w){console.error("PaymentSuccess: Error refreshing user:",w)}setTimeout(()=>{l("/home")},2e3)}else{console.error("PaymentSuccess: Upgrade failed:",s);const w=s.error||s.message||"Upgrade failed. Please contact support.";t("error"),o(w)}}catch(r){console.error("PaymentSuccess: Upgrade error:",r);const a=r instanceof Error?r.message:"Unknown error";t("error"),o(`An error occurred during upgrade: ${a}. Please contact support if your account is not upgraded within 5 minutes.`)}}c&&!u.current&&b()},[c,i]),e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-slate-950 text-white px-6",children:e.jsxs("div",{className:"max-w-md w-full text-center",children:[p==="processing"&&e.jsxs("div",{className:"bg-slate-900 p-8 rounded-lg",children:[e.jsx(N,{className:"h-16 w-16 text-blue-400 mx-auto mb-4 animate-spin"}),e.jsx("h1",{className:"text-3xl font-bold mb-2",children:"Processing Payment"}),e.jsx("p",{className:"text-gray-400 mb-6",children:g})]}),p==="success"&&e.jsxs("div",{className:"bg-slate-900 p-8 rounded-lg",children:[e.jsx(U,{className:"h-16 w-16 text-blue-400 mx-auto mb-4"}),e.jsx("h1",{className:"text-3xl font-bold mb-2",children:"Welcome to Pro!"}),e.jsx("p",{className:"text-gray-400 mb-2",children:g}),e.jsx("p",{className:"text-sm text-gray-500 mb-6",children:"You now have access to all premium features."}),e.jsx("p",{className:"text-sm text-gray-600",children:"Redirecting to home..."})]}),p==="error"&&e.jsxs("div",{className:"bg-slate-900 p-8 rounded-lg",children:[e.jsx(k,{className:"h-16 w-16 text-red-400 mx-auto mb-4"}),e.jsx("h1",{className:"text-3xl font-bold mb-2",children:"Upgrade Issue"}),e.jsx("p",{className:"text-gray-400 mb-6",children:g}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(x,{onClick:()=>window.location.reload(),className:"w-full bg-blue-600 hover:bg-blue-700",children:"Try Again"}),e.jsx(x,{onClick:()=>l("/home"),variant:"outline",className:"w-full",children:"Go to Home"})]})]})]})})}export{I as default};
