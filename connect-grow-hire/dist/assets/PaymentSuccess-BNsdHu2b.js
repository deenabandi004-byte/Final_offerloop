import{u as k,ay as U,r as m,j as e,O as C,aA as E,aB as R}from"./vendor-react-DiVfGd0B.js";import{a as v,B as P}from"./index-CAu39nmG.js";import{g as b}from"./vendor-firebase-BQzy1uck.js";import{c as _,a as S}from"./analytics-BKO9ZQLz.js";function B(){const l=k(),[p]=U(),{user:c,refreshUser:y}=v(),[h,o]=m.useState("processing"),[g,r]=m.useState("Completing your upgrade..."),u=m.useRef(!1),i=p.get("session_id")||p.get("sessionId")||p.get("session")||(window.location.hash.includes("session_id=")?new URLSearchParams(window.location.hash.split("?")[1]||"").get("session_id"):null)||(window.location.search.includes("session_id=")?new URLSearchParams(window.location.search).get("session_id"):null);return m.useEffect(()=>{async function j(){var x;if(u.current){console.log("PaymentSuccess: Already processed, skipping...");return}if(console.log("PaymentSuccess: Starting upgrade process",{user:!!c,sessionId:i,url:window.location.href,search:window.location.search,hash:window.location.hash}),!c){console.error("PaymentSuccess: No user found"),o("error"),r("You must be logged in to complete the upgrade. Please sign in and try again.");return}if(c.tier==="pro"){console.log("PaymentSuccess: User is already Pro, skipping upgrade call"),o("success"),r("You are already upgraded to Pro! ðŸŽ‰"),setTimeout(()=>{l("/home")},2e3),u.current=!0;return}if(u.current=!0,!i){console.warn("PaymentSuccess: No session ID in URL, checking if user is already upgraded...");try{const a=b().currentUser;if(!a)throw new Error("Not authenticated");const f=await a.getIdToken(),d=window.location.hostname==="localhost"?"http://localhost:5001":"https://www.offerloop.ai",n=await fetch(`${d}/api/subscription-status`,{method:"GET",headers:{Authorization:`Bearer ${f}`}});if(n.ok){const s=await n.json();if(console.log("PaymentSuccess: Subscription status:",s),s.subscribed&&s.tier==="pro"){console.log("PaymentSuccess: User is already upgraded to Pro"),await y(),o("success"),r("You are already upgraded to Pro! ðŸŽ‰"),setTimeout(()=>{l("/home")},2e3);return}}console.error("PaymentSuccess: No session ID and user not upgraded"),o("error"),r("Missing session information. If you just completed payment, the upgrade may be processing. Please wait a moment and refresh, or contact support with your payment confirmation.");return}catch(t){console.error("PaymentSuccess: Error checking user status:",t),o("error"),r("Missing session information. Please contact support with your payment confirmation.");return}}try{o("processing"),r("Completing your upgrade...");const a=b().currentUser;if(!a)throw new Error("Not authenticated");const f=await a.getIdToken(),d=window.location.hostname==="localhost"?"http://localhost:5001":"https://www.offerloop.ai";console.log("PaymentSuccess: Calling complete-upgrade endpoint...",{API_URL:d,sessionId:i});const n=await fetch(`${d}/api/complete-upgrade`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${f}`},body:JSON.stringify({sessionId:i})});console.log("PaymentSuccess: Response status:",n.status);const s=await n.json();if(console.log("PaymentSuccess: Response data:",s),n.ok&&s.success){console.log("PaymentSuccess: Upgrade successful:",s),o("success"),r("Successfully upgraded to Pro! ðŸŽ‰");const w=((x=s.user)==null?void 0:x.tier)||"pro";_(w);try{await y(),console.log("PaymentSuccess: User data refreshed")}catch(N){console.error("PaymentSuccess: Error refreshing user:",N)}setTimeout(()=>{l("/home")},2e3)}else{console.error("PaymentSuccess: Upgrade failed:",s);const w=s.error||s.message||"Upgrade failed. Please contact support.";o("error"),r(w),S("checkout","complete_upgrade","api_error")}}catch(t){console.error("PaymentSuccess: Upgrade error:",t);const a=t instanceof Error?t.message:"Unknown error";o("error"),r(`An error occurred during upgrade: ${a}. Please contact support if your account is not upgraded within 5 minutes.`),S("checkout","complete_upgrade","network_error")}}c&&!u.current&&j()},[c,i]),e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-slate-950 text-white px-6",children:e.jsxs("div",{className:"max-w-md w-full text-center",children:[h==="processing"&&e.jsxs("div",{className:"bg-slate-900 p-8 rounded-lg",children:[e.jsx(C,{className:"h-16 w-16 text-blue-400 mx-auto mb-4 animate-spin"}),e.jsx("h1",{className:"text-3xl font-bold mb-2",children:"Processing Payment"}),e.jsx("p",{className:"text-gray-400 mb-6",children:g})]}),h==="success"&&e.jsxs("div",{className:"bg-slate-900 p-8 rounded-lg",children:[e.jsx(E,{className:"h-16 w-16 text-blue-400 mx-auto mb-4"}),e.jsx("h1",{className:"text-3xl font-bold mb-2",children:"Welcome to Pro!"}),e.jsx("p",{className:"text-gray-400 mb-2",children:g}),e.jsx("p",{className:"text-sm text-gray-500 mb-6",children:"You now have access to all premium features."}),e.jsx("p",{className:"text-sm text-gray-600",children:"Redirecting to home..."})]}),h==="error"&&e.jsxs("div",{className:"bg-slate-900 p-8 rounded-lg",children:[e.jsx(R,{className:"h-16 w-16 text-red-400 mx-auto mb-4"}),e.jsx("h1",{className:"text-3xl font-bold mb-2",children:"Upgrade Issue"}),e.jsx("p",{className:"text-gray-400 mb-6",children:g}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(P,{onClick:()=>window.location.reload(),className:"w-full bg-blue-600 hover:bg-blue-700",children:"Try Again"}),e.jsx(P,{onClick:()=>l("/home"),variant:"outline",className:"w-full",children:"Go to Home"})]})]})]})})}export{B as default};
